---
title: "Modeling_Ye"
author: "Elaine Ye"
date: "12/07/2021"
output: html_document
---

There are two types of Citi Bike users: one is **Subscribers** who purchase annual membership, and the other is **Customers** who purchase 24-hour pass or 3-day pass. In this analysis, I am interested in understanding what factors predict a trip is initiated by a Subscriber or Customer. To investigate this problem, I use XGboost model to predict user type with variables of gender, age, median household income of the neighborhood where a bike is located, the distance to the nearest subway in meters, the length of trip duration in minutes, day of week, county, and winter. 


```{r message=FALSE, warning=FALSE}
library(lubridate)
library(tidyverse)
library(xgboost)
library(Matrix)
library(caret)
load("bike_join.RData")
set.seed(260)
#only take 10% data for modeling due to limited computational power 
bike_sub <- bike_join%>%
  group_by(trip_date) %>% sample_frac(0.1) %>%
  filter(gender != 0)
#actual proportion of subscribers and customers 
prop.table(table(bike_sub$user_type))
```

```{r}
bike_mod <- bike_sub %>%
  ungroup() %>%
  #create day of week variable 
  mutate(wday = ifelse(day_of_week )) %>%
   mutate(month = month(start_time)) %>%
    mutate(winter = ifelse(month %in% c(12,1,2), 1, 0))  %>%
  mutate(user_type = ifelse(user_type == "Subscriber", 1, 0)) %>%
  select(c(user_type, gender, age, median_household_income, distance_m, trip_min, day_of_week, county, winter))

set.seed(260)
options(na.action="na.pass")
#split train:test = 80%:20%
ind <- sample(2, nrow(bike_mod), replace = T, prob = c(0.8, 0.2))
train <- bike_mod[ind==1,]
test <- bike_mod %>% anti_join(train)
#one hot encode categorical variables for modeling 
training <- model.matrix(~.+0, data = train[,-1])
testing <- model.matrix(~.+0, data = test[,-1])
 
train.labels <- as.integer(train$user_type)
test.labels <- as.integer(test$user_type)

```

```{r}
#create train.test matrix for XGboost model 
xgb.train = xgb.DMatrix(data=training,label=train.labels)
xgb.test = xgb.DMatrix(data=testing,label=test.labels)

xgb.fit=xgb.train(
  booster="gbtree",
  #step size shrinkage 
  eta=0.1,
  #maximum depth of a tree 
  max_depth=8,
  #subsample ratio of the training to prevent overfitting
  subsample = 0.7,
  objective="binary:logistic",
  data=xgb.train,
  nrounds=50,
)

xgb.pred <- predict(xgb.fit, testing)
#use 0.5 cutoff 
xgb.pred <- ifelse(xgb.pred > 0.5, 1, 0)

confusionMatrix(as.factor(xgb.pred), as.factor(test.labels), positive = "1")

imp <- xgb.importance(feature_names = colnames(training), model = xgb.fit) 

pimp <- imp %>%
  mutate(Feature = fct_reorder(Feature, Gain)) %>%
  ggplot(data = ., aes(x=Gain, y = Feature)) +
  geom_col(fill = "#213272") +
  labs(title = "Feature Importance of XGboost for Prediction of User Type",
       x = "Features",
       y= "Gain") +
  theme_light() +
   theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) 
pimp
```



The confusion matrix shows that the overall accuracy is 85.4%. The feature importance plot shows that the most predictive factors of user type are age, trip duration in minutes, and winter season. 


While the model successful captures 98% of true subscribers, it only accurately predict 14.5% of true customers as actual customer. Considering the percentage of subscriber in the dataset is 85%, this model basically does no better than simply guessing. There are several explanations for the model performance:     


1. While XGboost model already improves its model performance by building on weak learners, imbalanced class might still be a major problem in this dataset, and therefore we might want to account for that using stratified sample or oversampling from the minority class. 


2. The variables I picked might not be important to predict user type and we might want to consider other variables. 


3. Since each row is a bike trip, the model is predicting whether the person rides the bike is a subscriber/ customer based on the features of a bike trip, rather than predicting whether a person is a subscriber/ customer given their user behaviors. So there might not be clearly different patterns among bike trips initiated by subscribers and customers to make a good prediction. Alternatively, if we have more data, we might want a dataset with each user as a row and use their behaviors to predict their user type. 




